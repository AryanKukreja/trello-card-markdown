<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="https://p.trellocdn.com/power-up.min.css">
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <title>Authorize</title>
</head>
<body>
<h1>
  Hey there! ðŸ˜€
</h1>
<p>
  To make full use of our Power-Up, we're going to need you to authorize us to access your Trello account!
</p>
<button id="auth-btn" type="submit" class="mod-primary">Authorize Access To Trello</button>

<script>
    require('dotenv').config({path: '../../.env'});

    let Promise = TrelloPowerUp.Promise;
    let t = TrelloPowerUp.iframe();

    let apiKey = t.arg('apiKey'); // Passed in as an argument to our iframe
    let trelloAuthUrl = `https://trello.com/1/authorize?expiration=1hour&name=Example%20Trello%20Power-Up&scope=read&key=${apiKey}&callback_method=fragment&return_url=${window.location.origin}%2Fauth-success.html`;

    let tokenLooksValid = function(token) {
        return /^[0-9a-f]{64}$/.test(token);
    }

    document.getElementById('auth-btn').addEventListener('click', function(){
        t.authorize(trelloAuthUrl, { height: 680, width: 580, validToken: tokenLooksValid })
            .then(function(token){
                return t.set('member', 'private', 'token', token)
                process.env['TRELLO_TOKEN'] = token.toString();
            })
            .then(function(){
                return t.closePopup();
            });
    });
</script>
</body>
</html>
